/*! @name videojs-concurrence-limiter @version 1.0.0 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):e.videojsConcurrenceLimiter=t(e.videojs)}(this,function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var t={"CL-001":"Concurrence denied by server.","CL-002":"No connection to the network."},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},s=function(e){function o(n,s){r(this,o);for(var a=arguments.length,c=Array(a>2?a-2:0),p=2;p<a;p++)c[p-2]=arguments[p];var u=i(this,e.call.apply(e,[this].concat(c)));return Error.captureStackTrace&&Error.captureStackTrace(u,o),u.code=n,u.message=t[n],u.name="CustomError",u}return n(o,e),o.parseError=function(e){if(!e.code)return new o(a.noConnection);switch(e.code){case 20:return new o(a.noConnection)}},o}(Error),a={deniedConcurrence:"CL-001",noConnection:"CL-002"},c={interval:10,access:{url:"http://localhost:55555/canplay",retry:0},update:{url:"http://localhost:55555/nowplaying",retry:1},stop:{url:"http://localhost:55555/stop",retry:0},playerId:"ssi-b7ture9aj",request:{method:"POST",timeout:15,headers:{"Content-Type":"application/json",Authorization:"JWT eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJUb29sYm94IERpZ2l0YWwgU0EiLCJhdWQiOiJ1bml0eS1kZXYudGJ4YXBpcy5jb20iLCJpYXQiOjE1MzA3MzA4MzksImV4cCI6MTUzMDkwMzYzOSwiY291bnRyeSI6IkFSIiwibGFuZ3VhZ2UiOiJlbiIsImNsaWVudCI6IjE4MGRmZjBhZDBlZjRlMTJkZDJjZGIyOWU0NzM2MDY4IiwiZGV2aWNlIjoiOGU5MGJmNDAwNTA2MDBlNDczYmQ2OTY2ZGIxMzIwMDNmZTMwZDdlMCIsImluZGV4IjoiNTc1MTllNDJiY2FlYWVjMTJkNjI0NTUxIiwiY3VzdG9tZXIiOiI1N2YyYTVhZjBmODcyOTg1N2VlMDUxZjgiLCJtYXhSYXRpbmciOjQsInByb2ZpbGUiOiI1OGMwNjlkMmM3NmJjNDIwMDBiMTQ4YjIifQ.zpUyR41iLKsWzvO_cF_LZGmhWVkomNoxoNouKLoxrm8"}},showAlert:!0,errorMsg:null},p=function(t){function p(o,n){r(this,p);var s=i(this,t.call(this,o));return s.options=e.mergeOptions(c,n),s.setState({currentTime:0,token:"",intervalId:0}),s.player.ready(function(){s.player.addClass("vjs-concurrence-limiter"),s.validatePlay()}),s.player.on("timeupdate",s.onTimeUpdate.bind(s)),s}return n(p,t),p.prototype.makeRequest=function(e,t,r){var o,n=this,i=new AbortController;return this.pendingRequest?Promise.reject("...Pending Request..."):(t.signal=i.signal,this.pendingRequest=!0,o=setTimeout(function(){return i.abort()},1e3*t.timeout),fetch(e,t).then(function(e){if(clearTimeout(o),e.ok)return n.pendingRequest=!1,e.json();throw new Error("Response error")}).then(function(e){if(!e.success||e.player!==n.options.playerId)throw r=0,new s(a.deniedConcurrence);return e}).catch(function(i){clearTimeout(o),r>0?(n.pendingRequest=!1,n.makeRequest(e,t,r-1)):n.blockPlayer(i)}))},p.prototype.validatePlay=function(){var e=this,t=this.options.access,r=o({},this.options.request);r.body=JSON.stringify({player:this.options.playerId}),this.makeRequest(t.url,r,t.retry).then(function(t){e.player.trigger("tbxplayeraccess"),e.intervalId=setInterval(e.update.bind(e),1e3*e.options.interval)})},p.prototype.update=function(){var e=this,t=this.options.update,r=o({},this.options.request);r.body=JSON.stringify({player:this.options.playerId,position:this.currentTime,token:this.token}),this.makeRequest(t.url,r,t.retry).then(function(t){e.player.trigger("tbxplayerupdate"),e.token=t.token})},p.prototype.onTimeUpdate=function(){var e=this.player&&this.player.currentTime();this.currentTime=Math.round(e)},p.prototype.dispose=function(){clearInterval(this.intervalId),this.player.off("timeupdate",this.onTimeUpdate.bind(this));var e=this.options.stop,r=o({},this.options.request);r.body=JSON.stringify({player:this.options.playerId,position:this.currentTime,token:this.token}),this.makeRequest(e.url,r,e.retry),t.prototype.dispose.call(this)},p.prototype.blockPlayer=function(t){var r=t;if("CustomError"!==r.name&&(r=s.parseError(t)),e.log.error(r),this.player.trigger("tbxplayerblocked",r),this.options.showAlert){var o=this.options.errorMsg||this.player.localize(r.code);setTimeout(function(){return alert(o)},0)}this.player.dispose()},p}(e.getPlugin("plugin"));return p.defaultState={},p.VERSION="1.0.0",e.registerPlugin("concurrenceLimiter",p),p});
